---
import BaseLayout from '../layouts/BaseLayout.astro';
import MeetingCard from '../components/MeetingCard.astro';
import FilterBar from '../components/FilterBar.astro';
import HeroSearch from '../components/HeroSearch.astro';
import Pagination from '../components/Pagination.astro';
import meetingsData from '../data/meetings.json';

// Pagination config
const ITEMS_PER_PAGE = 24;

// Get query params for filtering and pagination
const url = Astro.url;
const selectedType = url.searchParams.get('type') || undefined;
const currentPage = Math.max(1, Number(url.searchParams.get('page')) || 1);

// Ensure base URL ends with /
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

// Get unique meeting types
const meetingTypes = [...new Set(
  meetingsData.meetings
    .map(m => m.type)
    .filter((t): t is string => Boolean(t))
)].sort();

// Filter meetings
let filteredMeetings = meetingsData.meetings;
if (selectedType) {
  filteredMeetings = filteredMeetings.filter(m => m.type === selectedType);
}

// Pagination
const totalPages = Math.ceil(filteredMeetings.length / ITEMS_PER_PAGE);
const validPage = Math.min(currentPage, totalPages || 1);
const paginatedMeetings = filteredMeetings.slice(
  (validPage - 1) * ITEMS_PER_PAGE,
  validPage * ITEMS_PER_PAGE
);

// Stats
const totalMeetings = meetingsData.metadata.totalMeetings;
const dateRange = meetingsData.metadata.dateRange;

// Get the latest meeting for the summary section
const latestMeeting = meetingsData.meetings[0];

// Format date for latest meeting - shorter format
const latestMeetingDate = latestMeeting?.date ? new Date(latestMeeting.date).toLocaleDateString('en-US', {
  month: 'short',
  day: 'numeric',
  year: 'numeric'
}) : null;

// Get a clean single highlight from latest meeting
const latestHighlight = latestMeeting?.summary?.[0]?.replace(/^[-•]\s*/, '').trim() || null;

// Preserve params for pagination links
const preserveParams: Record<string, string> = {};
if (selectedType) preserveParams.type = selectedType;
---

<BaseLayout title="Meeting Archive">
  <!-- Hero section with search - cleaner -->
  <section class="bg-base-200 rounded-box p-6 md:p-8 mb-6 text-center">
    <p class="text-xs text-base-content/50 mb-3 uppercase tracking-wide">
      Unofficial &bull; Independent Research Project
    </p>
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-base-content mb-3">
      Chico City Council Archive
    </h1>
    <p class="text-base-content/60 mb-5 max-w-xl mx-auto">
      Search {totalMeetings} meetings with full transcripts and voting records.
    </p>
    <HeroSearch />
  </section>

  <!-- Latest meeting - simplified to single line with expand -->
  {latestMeeting && (
    <a
      href={`${base}meetings/${latestMeeting.id}`}
      class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4 bg-base-200/50 hover:bg-base-200 rounded-lg px-4 py-3 mb-6 border border-base-300/50 hover:border-primary/30 transition-colors group"
    >
      <div class="flex items-center gap-3 min-w-0">
        <span class="badge badge-primary badge-sm shrink-0">Latest</span>
        <span class="text-sm font-medium text-base-content truncate group-hover:text-primary transition-colors">
          {latestMeeting.title}
        </span>
      </div>
      <span class="text-xs text-base-content/50 shrink-0 sm:text-right">
        {latestMeetingDate}
      </span>
    </a>
  )}

  <!-- Filter chips -->
  <FilterBar
    meetingTypes={meetingTypes}
    selectedType={selectedType}
    totalCount={totalMeetings}
  />

  <!-- Results count - more subtle -->
  <div class="mb-4">
    <p class="text-xs text-base-content/50">
      {selectedType
        ? `${filteredMeetings.length} ${selectedType} meeting${filteredMeetings.length !== 1 ? 's' : ''}`
        : `${filteredMeetings.length} meetings`
      }
      {totalPages > 1 && ` · Page ${validPage} of ${totalPages}`}
    </p>
  </div>

  <!-- Meeting grid - more gap for breathing room -->
  <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
    {paginatedMeetings.map(meeting => (
      <MeetingCard
        id={meeting.id}
        title={meeting.title}
        date={meeting.date}
        type={meeting.type || 'Unknown'}
        summary={meeting.summary}
        voteCount={meeting.votes?.length || 0}
      />
    ))}
  </div>

  {filteredMeetings.length === 0 && (
    <div class="text-center py-12">
      <p class="text-base-content/60">No meetings found matching your filters.</p>
      <a href={base} class="btn btn-primary btn-sm mt-4">Clear filters</a>
    </div>
  )}

  <!-- Pagination -->
  <Pagination
    currentPage={validPage}
    totalPages={totalPages}
    baseUrl={base}
    preserveParams={preserveParams}
  />
</BaseLayout>
