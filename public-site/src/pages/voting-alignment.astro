---
import BaseLayout from '../layouts/BaseLayout.astro';
import alignmentData from '../data/alignment.json';

// Ensure base URL ends with /
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

const { matrix, members } = alignmentData;

// Filter to members with meaningful data (at least some alignment scores)
const activeMembers = members.filter((m: string) => {
  const scores = Object.values(matrix[m] || {}).filter((s: any) => s !== null && s !== 100);
  return scores.length >= 3;
});

// Get color class based on alignment percentage
function getAlignmentColor(percent: number | null): string {
  if (percent === null) return 'bg-base-300 text-base-content/30';
  if (percent === 100) return 'bg-base-200 text-base-content/50'; // Self
  if (percent >= 90) return 'bg-success text-success-content';
  if (percent >= 75) return 'bg-info text-info-content';
  if (percent >= 60) return 'bg-warning text-warning-content';
  return 'bg-error text-error-content';
}

// Get alignment label
function getAlignmentLabel(percent: number | null): string {
  if (percent === null) return 'N/A';
  if (percent === 100) return '-';
  return `${Math.round(percent)}%`;
}
---

<BaseLayout title="Voting Alignment">
  <!-- Back navigation -->
  <a href={`${base}members`} class="inline-flex items-center gap-2 text-sm text-base-content/60 hover:text-primary mb-4 group">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Members
  </a>

  <header class="mb-8">
    <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">
      Voting Alignment Matrix
    </h1>
    <p class="text-base-content/70 max-w-2xl">
      How often do council members vote the same way? This matrix shows the percentage of shared
      votes where two members voted identically. Higher percentages indicate more aligned voting patterns.
    </p>
  </header>

  <!-- Legend -->
  <div class="flex flex-wrap gap-4 mb-6 text-sm">
    <div class="flex items-center gap-2">
      <span class="w-6 h-6 rounded bg-success"></span>
      <span>90%+ (Very aligned)</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-6 h-6 rounded bg-info"></span>
      <span>75-89% (Often aligned)</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-6 h-6 rounded bg-warning"></span>
      <span>60-74% (Sometimes aligned)</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-6 h-6 rounded bg-error"></span>
      <span>&lt;60% (Rarely aligned)</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-6 h-6 rounded bg-base-300"></span>
      <span>Insufficient data</span>
    </div>
  </div>

  <!-- Alignment matrix table -->
  <div class="overflow-x-auto bg-base-200 rounded-box border border-base-300">
    <table class="table table-compact w-full">
      <thead>
        <tr>
          <th class="bg-base-300 sticky left-0 z-10"></th>
          {activeMembers.map((member: string) => (
            <th class="text-center text-xs font-medium bg-base-300 px-2 py-3 min-w-[60px]">
              <a href={`${base}members/${encodeURIComponent(member)}`} class="hover:text-primary">
                {member.split(' ').pop()}
              </a>
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {activeMembers.map((member1: string) => (
          <tr>
            <th class="font-medium text-sm bg-base-300 sticky left-0 z-10 whitespace-nowrap">
              <a href={`${base}members/${encodeURIComponent(member1)}`} class="hover:text-primary">
                {member1}
              </a>
            </th>
            {activeMembers.map((member2: string) => {
              const alignment = matrix[member1]?.[member2];
              return (
                <td class={`text-center text-xs font-medium p-2 ${getAlignmentColor(alignment)}`}>
                  {getAlignmentLabel(alignment)}
                </td>
              );
            })}
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <!-- Notes -->
  <div class="mt-6 bg-base-200 rounded-box p-4 border border-base-300">
    <h3 class="font-semibold text-base-content mb-2">How to Read This Matrix</h3>
    <ul class="text-sm text-base-content/80 space-y-1">
      <li>Each cell shows the percentage of votes where both members voted the same way (yes/yes or no/no).</li>
      <li>Only votes where both members participated are counted.</li>
      <li>Members with fewer than {alignmentData.minSharedVotes} shared votes show "N/A".</li>
      <li>Diagonal cells ("-") represent self-comparison.</li>
    </ul>
  </div>

  <!-- Top alignments -->
  <div class="mt-8">
    <h2 class="text-xl font-semibold text-base-content mb-4">Notable Voting Pairs</h2>
    <div class="grid gap-4 md:grid-cols-2">
      <!-- Most aligned -->
      <div class="bg-base-200 rounded-box p-4 border border-base-300">
        <h3 class="font-semibold text-success mb-3">Most Aligned</h3>
        <ul class="space-y-2">
          {(() => {
            const pairs: { member1: string; member2: string; percent: number }[] = [];
            for (const m1 of activeMembers) {
              for (const m2 of activeMembers) {
                if (m1 < m2 && matrix[m1]?.[m2] !== null && matrix[m1]?.[m2] !== 100) {
                  pairs.push({ member1: m1, member2: m2, percent: matrix[m1][m2] });
                }
              }
            }
            return pairs
              .sort((a, b) => b.percent - a.percent)
              .slice(0, 5)
              .map(pair => (
                <li class="flex justify-between text-sm">
                  <span>{pair.member1} & {pair.member2}</span>
                  <span class="font-medium text-success">{Math.round(pair.percent)}%</span>
                </li>
              ));
          })()}
        </ul>
      </div>

      <!-- Least aligned -->
      <div class="bg-base-200 rounded-box p-4 border border-base-300">
        <h3 class="font-semibold text-error mb-3">Least Aligned</h3>
        <ul class="space-y-2">
          {(() => {
            const pairs: { member1: string; member2: string; percent: number }[] = [];
            for (const m1 of activeMembers) {
              for (const m2 of activeMembers) {
                if (m1 < m2 && matrix[m1]?.[m2] !== null && matrix[m1]?.[m2] !== 100) {
                  pairs.push({ member1: m1, member2: m2, percent: matrix[m1][m2] });
                }
              }
            }
            return pairs
              .sort((a, b) => a.percent - b.percent)
              .slice(0, 5)
              .map(pair => (
                <li class="flex justify-between text-sm">
                  <span>{pair.member1} & {pair.member2}</span>
                  <span class="font-medium text-error">{Math.round(pair.percent)}%</span>
                </li>
              ));
          })()}
        </ul>
      </div>
    </div>
  </div>

  <!-- Link back to members -->
  <div class="mt-8 text-center">
    <a href={`${base}members`} class="btn btn-outline btn-primary">
      View Individual Voting Records
    </a>
  </div>
</BaseLayout>
